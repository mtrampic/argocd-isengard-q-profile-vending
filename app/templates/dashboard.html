<!DOCTYPE html>
<html>
<head>
    <title>Q Profile Vending - Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logout-btn { background: #dc3545; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; }
        .logout-btn:hover { background: #c82333; }
        .card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .alert { padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .status { padding: 5px 10px; border-radius: 4px; font-size: 12px; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Q Profile Vending System - {{ user_role.title() }}</h1>
        <div>
            <span id="connection-status" class="status disconnected">Disconnected</span>
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    
    {% if user_role == 'admin' %}
    <div class="card">
        <h3>AWS Credentials Configuration</h3>
        <form id="aws-credentials-form">
            <div class="form-group">
                <label for="access_key">AWS Access Key ID:</label>
                <input type="text" id="access_key" name="access_key" required>
            </div>
            <div class="form-group">
                <label for="secret_key">AWS Secret Access Key:</label>
                <input type="password" id="secret_key" name="secret_key" required>
            </div>
            <div class="form-group">
                <label for="identity_store_id">Identity Store ID:</label>
                <input type="text" id="identity_store_id" name="identity_store_id" placeholder="d-xxxxxxxxxx" required>
            </div>
            <button type="submit" class="btn">Update AWS Credentials</button>
        </form>
    </div>
    {% endif %}
    
    {% if user_role == 'participant' %}
    {% endwith %}
    
    <div class="card">
        <h3>Create New User in AWS Identity Center</h3>
        <form id="user-form">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="first_name">First Name:</label>
                <input type="text" id="first_name" name="first_name">
            </div>
            <div class="form-group">
                <label for="last_name">Last Name:</label>
                <input type="text" id="last_name" name="last_name">
            </div>
            <button type="submit" class="btn">Create User in Identity Center</button>
        </form>
    </div>
    {% endif %}
    
    <div class="card">
        <h3>Users ({{ users|length }} total)</h3>
        <table id="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>AWS User ID</th>
                    <th>Created At</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.aws_user_id or 'N/A' }}</td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <script>
        const socket = io();
        const statusEl = document.getElementById('connection-status');
        const userForm = document.getElementById('user-form');
        const awsCredentialsForm = document.getElementById('aws-credentials-form');
        const usersTable = document.getElementById('users-table').getElementsByTagName('tbody')[0];

        socket.on('connect', function() {
            statusEl.textContent = 'Connected';
            statusEl.className = 'status connected';
        });

        socket.on('disconnect', function() {
            statusEl.textContent = 'Disconnected';
            statusEl.className = 'status disconnected';
        });

        socket.on('user_created', function(user) {
            const row = usersTable.insertRow(0);
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${user.aws_user_id || 'N/A'}</td>
                <td>${new Date(user.created_at).toLocaleString()}</td>
            `;
            row.style.backgroundColor = '#d4edda';
            setTimeout(() => row.style.backgroundColor = '', 2000);
        });

        // AWS Credentials form handler
        if (awsCredentialsForm) {
            awsCredentialsForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(awsCredentialsForm);
                const credentialsData = {
                    access_key: formData.get('access_key'),
                    secret_key: formData.get('secret_key'),
                    identity_store_id: formData.get('identity_store_id')
                };

                try {
                    const response = await fetch('/api/aws-credentials', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(credentialsData)
                    });

                    const result = await response.json();
                    if (response.ok) {
                        alert('AWS credentials updated successfully!');
                        awsCredentialsForm.reset();
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Error updating credentials: ' + error.message);
                }
            });
        }

        // User creation form handler
        if (userForm) {
            e.preventDefault();
            
            const formData = new FormData(userForm);
            const userData = {
                username: formData.get('username'),
                email: formData.get('email'),
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name')
            };

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    userForm.reset();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                alert('Error creating user: ' + error.message);
            }
        });
        }
    </script>
</body>
</html>
