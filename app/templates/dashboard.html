<!DOCTYPE html>
<html>
<head>
    <title>Q Profile Vending - Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logout-btn { background: #dc3545; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; }
        .logout-btn:hover { background: #c82333; }
        .card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .alert { padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .loading { opacity: 0.6; pointer-events: none; }
        .spinner { 
            display: inline-block; 
            width: 16px; 
            height: 16px; 
            border: 2px solid #f3f3f3; 
            border-top: 2px solid #007bff; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .instructions { 
            background: #e7f3ff; 
            border-left: 4px solid #007bff; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 4px; 
        }
        .copy-value { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            padding: 8px 12px; 
            border-radius: 4px; 
            font-family: monospace; 
            display: inline-block; 
            margin: 0 5px; 
            cursor: pointer; 
            position: relative;
        }
        .copy-value:hover { background: #e9ecef; }
        .copy-value::after { 
            content: 'üìã'; 
            position: absolute; 
            right: 5px; 
            top: 50%; 
            transform: translateY(-50%); 
            opacity: 0.7; 
        }
        .copied { background: #d4edda !important; }
        .instructions ol { margin: 10px 0; }
        .instructions li { margin: 8px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background-color: #f8f9fa; }
        .status { padding: 5px 10px; border-radius: 4px; font-size: 12px; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .aws-info { background: #e7f3ff; border-left: 4px solid #007bff; padding: 15px; margin-bottom: 20px; }
        .aws-error { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Q Profile Vending System</h1>
        <div>
            <span id="connection-status" class="status disconnected">Disconnected</span>
            <button onclick="togglePolling()" class="btn" style="font-size: 12px; padding: 5px 10px; margin-left: 10px;">Force Polling</button>
            <button onclick="checkSSEStatus()" class="btn" style="font-size: 12px; padding: 5px 10px;">SSE Status</button>
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>
    </div>
    
    <div class="card" style="background: #d1ecf1; border-left: 4px solid #17a2b8; margin-bottom: 20px; padding: 20px;">
        <h3>üéØ Workshop Access</h3>
        <p><strong>First, get your AWS account access:</strong></p>
        <p>üëâ <a href="https://catalog.us-east-1.prod.workshops.aws/join?access-code=49e0-0a0d1b-53" target="_blank" style="color: #17a2b8; font-weight: bold;">Join Workshop Studio</a></p>
        <p><small>This will provide you with temporary AWS account access for the workshop.</small></p>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="card">
        <h3>Create New User in AWS Identity Center</h3>
        <div style="background: #e7f3ff; border-left: 4px solid #007bff; padding: 20px; margin: 15px 0; border-radius: 4px;">
            
            <div style="text-align: center; margin: 0 0 20px 0;">
                <img src="/static/mcp.png" alt="MCP Overview" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px;">
            </div>

            <h4>What is MCP?</h4>
            <p>Model Context Protocol (MCP) is an open standard that enables AI assistants to securely connect with external data sources and tools. It provides a standardized way for AI models to access real-time information and execute actions across different systems.</p>
            
            <h4>Key Benefits</h4>
            <ul>
                <li><strong>Unified Integration:</strong> One protocol to connect multiple data sources</li>
                <li><strong>Security First:</strong> Built-in authentication and permission controls</li>
                <li><strong>Real-time Data:</strong> Access live information from databases, APIs, and files</li>
                <li><strong>Extensible:</strong> Easy to add new tools and capabilities</li>
            </ul>

            <h4>Common Use Cases</h4>
            <ul>
                <li>Database queries and analysis</li>
                <li>File system operations</li>
                <li>API integrations</li>
                <li>Development tool automation</li>
                <li>Custom business logic execution</li>
            </ul>

            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin-top: 15px;">
                <strong>üí° Pro Tip:</strong> Start with simple MCP servers like filesystem or database connections to understand the protocol, then build custom solutions for your specific workflows.
            </div>
        </div>
    </div>

    <div class="instructions">
        <h3>üß† Context Engineering Best Practices</h3>
        <p>Before working with Q CLI, read this important blog post: <a href="https://blog.langchain.com/the-rise-of-context-engineering/" target="_blank" style="color: #007bff;">The Rise of Context Engineering</a></p>
        
        <div style="background: #f8f9fa; border-left: 4px solid #28a745; padding: 20px; margin: 15px 0; border-radius: 4px;">
            
            <h4>Understanding Context in AI Tools</h4>
            <p>Large language models are <strong>stateless</strong> - each interaction is independent. AI tools create the illusion of memory by sending your entire conversation history with each new request. However, there's a hard limit (typically ~200,000 tokens) on how much input these models can process.</p>

            <h4>The Context Window Challenge</h4>
            <p>AI tools use a <strong>sliding context window</strong>. As conversations grow, older messages "age off" and are no longer included in requests. This creates the experience that the model "forgets" earlier parts of your conversation.</p>

            <h4>Why Context Matters</h4>
            <ul>
                <li><strong>Steer Behavior:</strong> Provide coding standards, writing guidelines, or team conventions to get output that matches your preferred style</li>
                <li><strong>Add Knowledge:</strong> Models only know information from their training data. For newer tools, APIs, or internal processes, you must provide the relevant documentation</li>
            </ul>

            <h4>Context Management Techniques</h4>
            <ul>
                <li><strong>Static Knowledge Files:</strong> Team coding conventions, templates, standards that rarely change</li>
                <li><strong>Dynamic Knowledge:</strong> Files created by the AI during tasks to maintain working notes</li>
                <li><strong>Knowledge Bases:</strong> Searchable document indexes for large amounts of information</li>
                <li><strong>Code-Based Knowledge:</strong> Specialized tools for navigating large codebases efficiently</li>
            </ul>

            <h4>The Goldilocks Problem</h4>
            <p>Context management requires balance:</p>
            <ul>
                <li><strong>Too little context</strong> ‚Üí Hallucinations and generic responses</li>
                <li><strong>Too much context</strong> ‚Üí Confusion and missed relevant information</li>
            </ul>

            <h4>Best Practices</h4>
            <ul>
                <li>Be aware of what's in your context at all times</li>
                <li>Prune unnecessary files and conversation history at logical checkpoints</li>
                <li>Provide hints or reminders to help the model find relevant information</li>
                <li>Practice context management - it's a critical skill that improves with experience</li>
            </ul>

            <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 4px; margin-top: 15px;">
                <strong>üí° Pro Tip:</strong> You don't need perfect context. AI models can find information in large amounts of text, but they need your help to focus on what's most relevant to your current task.
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <img src="/static/Usage_Command.png" alt="Q CLI Usage Commands" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px;">
            </div>
        </div>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    <div class="card">
        <h3>Create New User in AWS Identity Center</h3>
        <form id="user-form">
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="first_name">First Name:</label>
                <input type="text" id="first_name" name="first_name">
            </div>
            <div class="form-group">
                <label for="last_name">Last Name:</label>
                <input type="text" id="last_name" name="last_name">
            </div>
            <button type="submit" class="btn">Create User in Identity Center</button>
        </form>
    </div>
    
    <div class="card">
        <h3>Users ({{ users|length }} total)</h3>
        <table id="users-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Email</th>
                    <th>AWS User ID</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr id="user-{{ user.id }}">
                    <td>{{ user.id }}</td>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.aws_user_id or 'N/A' }}</td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td>
                        <button onclick="deleteUser({{ user.id }})" class="btn btn-danger btn-sm">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="instructions">
        <h3>üìã Setup Instructions</h3>
        <p>Once your user is created and visible in the table above, please follow these steps:</p>
        <ol>
            <li>Go to <span class="copy-value" onclick="copyToClipboard(this)">https://trampic-isengard.awsapps.com/start</span> and login with your username</li>
            <li>You will receive an email with an OTP code for activation</li>
            <li>For Q CLI login setup:
                <ul>
                    <li>Select option: <strong>"Use with Pro license"</strong></li>
                    <li>Enter Start URL: <span class="copy-value" onclick="copyToClipboard(this)">https://trampic-isengard.awsapps.com/start</span></li>
                    <li>Enter Region: <span class="copy-value" onclick="copyToClipboard(this)">eu-central-1</span></li>
                </ul>
            </li>
        </ol>
        <p><small>üí° <strong>Tip:</strong> Click on the gray boxes above to copy values to your clipboard</small></p>
    </div>

    <script>
        const statusEl = document.getElementById('connection-status');
        const userForm = document.getElementById('user-form');
        const usersTable = document.getElementById('users-table').getElementsByTagName('tbody')[0];
        let eventSource = null;
        let fallbackInterval = null;

        // Enhanced SSE connection with fallback
        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            console.log('üîå Connecting to SSE...');
            eventSource = new EventSource('/events');
            
            eventSource.onopen = function() {
                console.log('‚úÖ SSE Connected');
                statusEl.textContent = 'Connected (SSE)';
                statusEl.className = 'status connected';
                // Clear fallback polling if SSE is working
                if (fallbackInterval) {
                    clearInterval(fallbackInterval);
                    fallbackInterval = null;
                    console.log('üõë Stopped fallback polling - SSE working');
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('‚ùå SSE Error:', error);
                statusEl.textContent = 'Disconnected - Using Fallback';
                statusEl.className = 'status disconnected';
                // Start fallback polling
                startFallbackPolling();
            };
            
            eventSource.addEventListener('connected', function(e) {
                console.log('üéâ SSE Connected event received:', e.data);
                statusEl.textContent = 'Connected (SSE)';
                statusEl.className = 'status connected';
            });
            
            eventSource.addEventListener('user_created', function(e) {
                console.log('üë§ User created event received:', e.data);
                const user = JSON.parse(e.data);
                addUserToTable(user);
            });

            eventSource.addEventListener('user_deleted', function(e) {
                console.log('üóëÔ∏è User deleted event received:', e.data);
                const data = JSON.parse(e.data);
                removeUserFromTable(data.id);
            });

            eventSource.addEventListener('heartbeat', function(e) {
                console.log('üíì Heartbeat received:', e.data);
            });

            // Add message listener for any other events
            eventSource.addEventListener('message', function(e) {
                console.log('üì® SSE Message received:', e.data);
            });
        }

        // Fallback polling mechanism
        function startFallbackPolling() {
            if (fallbackInterval) return; // Already running
            
            console.log('üîÑ Starting fallback polling...');
            fallbackInterval = setInterval(async () => {
                try {
                    console.log('üì° Polling for updates...');
                    const response = await fetch('/api/users');
                    if (response.ok) {
                        const users = await response.json();
                        console.log(`üìä Received ${users.length} users from polling`);
                        refreshUserTable(users);
                        statusEl.textContent = 'Connected (Polling)';
                        statusEl.className = 'status connected';
                    } else {
                        console.error('‚ùå Polling failed:', response.status);
                    }
                } catch (error) {
                    console.error('‚ùå Polling error:', error);
                    statusEl.textContent = 'Connection Failed';
                    statusEl.className = 'status disconnected';
                }
            }, 5000); // Poll every 5 seconds
        }

        function addUserToTable(user) {
            console.log('‚ûï Adding user to table:', user);
            const tbody = document.querySelector('#users-table tbody');
            
            // Check if user already exists
            const existingRow = document.getElementById(`user-${user.id}`);
            if (existingRow) {
                console.log('‚ö†Ô∏è User already exists in table, skipping:', user.id);
                return;
            }
            
            const row = tbody.insertRow(0);
            row.id = `user-${user.id}`;
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.email}</td>
                <td>${user.aws_user_id || 'N/A'}</td>
                <td>${new Date(user.created_at).toLocaleString()}</td>
                <td><button onclick="deleteUser(${user.id})" class="btn btn-danger btn-sm">Delete</button></td>
            `;
            // Highlight new row
            row.style.backgroundColor = '#d4edda';
            setTimeout(() => row.style.backgroundColor = '', 2000);
            
            console.log('‚úÖ User added to table successfully');
            
            // Update counter
            updateUserCount();
        }

        function removeUserFromTable(userId) {
            console.log('üóëÔ∏è Removing user from table:', userId);
            const row = document.getElementById(`user-${userId}`);
            if (row) {
                row.style.backgroundColor = '#f8d7da';
                setTimeout(() => {
                    row.remove();
                    updateUserCount();
                    console.log('‚úÖ User removed from table successfully');
                }, 1000);
            } else {
                console.warn('‚ö†Ô∏è User row not found in table:', userId);
            }
        }

        function refreshUserTable(users) {
            console.log(`üîÑ Refreshing user table with ${users.length} users`);
            const tbody = document.querySelector('#users-table tbody');
            const currentIds = Array.from(tbody.querySelectorAll('tr')).map(row => 
                parseInt(row.id.replace('user-', ''))
            ).filter(id => !isNaN(id));
            const newIds = users.map(user => user.id);
            
            console.log('üìä Current table IDs:', currentIds);
            console.log('üìä New data IDs:', newIds);
            
            // Add new users
            users.forEach(user => {
                if (!currentIds.includes(user.id)) {
                    console.log('‚ûï Adding new user from polling:', user.id);
                    addUserToTable(user);
                }
            });
            
            // Remove deleted users
            currentIds.forEach(id => {
                if (!newIds.includes(id)) {
                    console.log('üóëÔ∏è Removing deleted user from polling:', id);
                    removeUserFromTable(id);
                }
            });
            
            console.log('‚úÖ Table refresh complete');
        }

        function updateUserCount() {
            const count = document.querySelectorAll('#users-table tbody tr').length;
            const header = document.querySelector('h3');
            header.textContent = `Users (${count} total)`;
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            
            try {
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to delete user');
                }
                
                // Row will be removed via SSE event or polling
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        userForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Creating...';
            
            const formData = new FormData(userForm);
            const userData = {
                username: formData.get('username'),
                email: formData.get('email'),
                first_name: formData.get('first_name'),
                last_name: formData.get('last_name')
            };

            try {
                const response = await fetch('/api/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });

                if (response.ok) {
                    userForm.reset();
                    console.log('User creation submitted successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                alert('Error creating user: ' + error.message);
            } finally {
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        // Initialize connection
        connectSSE();

        // Start a safety polling mechanism (every 30 seconds) to ensure table stays in sync
        // This is in addition to SSE for maximum reliability
        setInterval(async () => {
            // Only poll if we don't have an active SSE connection
            if (!eventSource || eventSource.readyState !== EventSource.OPEN) {
                console.log('üîÑ Safety poll - SSE not connected');
                try {
                    const response = await fetch('/api/users');
                    if (response.ok) {
                        const users = await response.json();
                        refreshUserTable(users);
                    }
                } catch (error) {
                    console.error('‚ùå Safety poll failed:', error);
                }
            }
        }, 30000); // Every 30 seconds

        // Reconnect on window focus (in case connection was lost)
        window.addEventListener('focus', () => {
            if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
                connectSSE();
            }
        });

        // Copy to clipboard function
        function copyToClipboard(element) {
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                const originalBg = element.style.backgroundColor;
                element.classList.add('copied');
                setTimeout(() => {
                    element.classList.remove('copied');
                }, 1000);
                
                // Optional: Show a small notification
                console.log(`Copied to clipboard: ${text}`);
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                element.classList.add('copied');
                setTimeout(() => {
                    element.classList.remove('copied');
                }, 1000);
            });
        }

        // Force polling toggle for testing
        function togglePolling() {
            if (fallbackInterval) {
                clearInterval(fallbackInterval);
                fallbackInterval = null;
                console.log('üõë Forced polling stopped');
            } else {
                startFallbackPolling();
                console.log('üîÑ Forced polling started');
            }
        }

        // Check SSE status for debugging
        async function checkSSEStatus() {
            try {
                const response = await fetch('/api/sse-status');
                if (response.ok) {
                    const status = await response.json();
                    console.log('üìä SSE Status:', status);
                    alert(`SSE Status:\n\nActive Connections: ${status.active_connections}\nTotal Events: ${status.total_events}\nRecent Events: ${JSON.stringify(status.recent_events, null, 2)}`);
                } else {
                    console.error('‚ùå Failed to get SSE status');
                }
            } catch (error) {
                console.error('‚ùå Error checking SSE status:', error);
            }
        }
    </script>
</body>
</html>
